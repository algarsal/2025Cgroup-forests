---
title: "06 - PRINCIPAL COMPONNET ANALYSIS"
format: html
---

```{r load data}
library(stringr)
#Load the data
load("Data/foret.Rdata")
foret$genus <- word(foret$Species, 1)


```

```{r Setup and Data Preparation}
ls()
#foret_active <- foret[, c(2:4, 6:10)]
foret_active <- foret[, sapply(foret, is.numeric)]
nrow(foret)
unique(foret$For.type)
unique(foret$Species)


df <- data.frame(
  other_var = c("a", "b", "c"),
  bark.thick = as.character(c(1.5, 2.1, 1.8)),
  bark.dry.mat.cont = as.character(c(0.4, 0.5, 0.3)),
  stem.tis.dens = as.character(c(0.6, 0.7, 0.5)),
  stringsAsFactors = FALSE
)

# A vector containing the names of the columns you want to convert
my_variables <- c("bark.thick", "bark.dry.mat.cont", "bark.tis.dens", "stem.dry.mat.cont", "stem.tis.dens", "bark.C.cont", "bark.N.cont", "bark.P.cont","bark.C.N.ratio", "bark.C.P.ratio", "bark.N.P.ratio", "stem.C.content","stem.N.cont", "stem.P.cont", "stem.C.P.ratio", "stem.N.P.ratio", "stem.C.N.ratio")

for(i in my_variables){
  foret[[i ]] <- as.numeric(foret[[i]])
}

numerical_vars <- names(foret)[sapply(foret, is.numeric)]
foret$bark.thick <- as.numeric(foret$bark.thick)
```

```{r PCA packages for anlysis }

#install.packages("FactoMineR")
#install.packages("factoextra")

library(FactoMineR)
library(factoextra)

res <- PCA(foret_active, scale.unit = TRUE, graph = FALSE)

```

```{r PCA Scree plot and Variance }


graph = FALSE 
res.pca <- PCA(foret_active, scale.unit = TRUE, graph = FALSE)
fviz_eig(res.pca, addlabels = TRUE)
fviz_pca_var(res.pca)
fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (not text labels)
             col.ind = "cos2",   # Color by quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)

```

\

\`

```{r  Comparison: Forest Type}
fig.cap="Figure 1:Biplot Grouped by Forest Type"

res.pca <- prcomp(foret[, 3:10],  scale = TRUE)


group_variable <- foret$For.type
fviz_pca_biplot(res.pca, 
                # Color individuals by the 'Species' variable
                habillage = group_variable,
                addEllipses = TRUE, # Optional: Add ellipses around groups
                ellipse.level = 0.95, # Optional: Set ellipse confidence level
                label = "var", # Only label variables (arrows/text)
                repel = TRUE, # Avoid text overlapping
                ggtheme = theme_minimal() # Use a clean ggplot theme
                )

          
```

```{r  Biplot Grouped by Genus}
fig.cap="Figure 2a: Biplot Grouped by Genus"

res.pca <- prcomp(foret[, 3:10],  scale = TRUE)
genus_counts <- table(foret$genus)
valid_genera <- names(genus_counts[genus_counts >= 3])
foret_filtered <- foret[foret$genus %in% valid_genera, ]
foretnan_filtered <- foret_filtered[, numerical_vars]
res.pca_filtered <- prcomp(foretnan_filtered, scale = TRUE) 
group_variable_filtered <- foret_filtered$genus
 
fviz_pca_biplot(res.pca_filtered, 
                # Color individuals by the filtered genus variable
                habillage = group_variable_filtered,
                addEllipses = TRUE, 
                ellipse.level = 0.95, 
                label = "var", 
                repel = TRUE, 
                # FIX: FORCE a standard, implemented point shape for ALL points
                pointshape = 19, # Use filled circle (19) or open circle (1)
                ggtheme = theme_minimal()
)

res.pca_filtered <- prcomp(foretnan_filtered, scale = TRUE) 
group_variable_filtered <- foret_filtered$genus

fig.cap="Figure 2b: Biplot Grouped by Genus)"
fviz_pca_biplot(res.pca_filtered,                 
                habillage = group_variable_filtered,
                addEllipses = TRUE,                 
                ellipse.level = 0.95,                 
                label = "var",                 
                repel = TRUE,                 
                # FIX: Forces a standard, implemented point shape to fix PCH warnings
                pointshape = 19, 
                ggtheme = theme_minimal()) +   
  ggplot2::theme(legend.position = "none") # Remove the legend
  


```

```         
```

\`\`\`{r}
