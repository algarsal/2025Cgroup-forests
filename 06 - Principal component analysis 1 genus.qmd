---
title: "06 - PRINCIPAL COMPONNET ANALYSIS"
format: html
---

```{r loadlibrary}
library(stringr)
library(MASS)
library(ggplot2)
library(dplyr)

```


```{r load data}
#Load the data
load("Data/foret.Rdata")
foret$genus <- word(foret$Species, 1)


```

```{r Setup and Data Preparation}
# ls()
#foret_active <- foret[, c(2:4, 6:10)]
foret_active <- foret[, sapply(foret, is.numeric)]
# nrow(foret)
# unique(foret$For.type)
# unique(foret$Species)


# df <- data.frame(
#   other_var = c("a", "b", "c"),
#   bark.thick = as.character(c(1.5, 2.1, 1.8)),
#   bark.dry.mat.cont = as.character(c(0.4, 0.5, 0.3)),
#   stem.tis.dens = as.character(c(0.6, 0.7, 0.5)),
#   stringsAsFactors = FALSE
# )

# A vector containing the names of the columns you want to convert
my_variables <- c("bark.thick", "bark.dry.mat.cont", "bark.tis.dens", "stem.dry.mat.cont", "stem.tis.dens", "bark.C.cont", "bark.N.cont", "bark.P.cont","bark.C.N.ratio", "bark.C.P.ratio", "bark.N.P.ratio", "stem.C.content","stem.N.cont", "stem.P.cont", "stem.C.P.ratio", "stem.N.P.ratio", "stem.C.N.ratio")

for(i in my_variables){
  foret[[i ]] <- as.numeric(foret[[i]])
}

numerical_vars <- names(foret)[sapply(foret, is.numeric)]
foret$bark.thick <- as.numeric(foret$bark.thick)
```

```{r PCA packages for anlysis }

#install.packages("FactoMineR")
#install.packages("factoextra")

library(FactoMineR)
library(factoextra)

# res <- PCA(foret_active, scale.unit = TRUE, graph = FALSE)

```



```{r pca}
d <- 
  foret[foret$genus == "Schima", ]
foretn <- d[, numerical_vars]
group_variable <- d$For.type
res.pca <- prcomp(foretn,  scale = TRUE)




group_variable <- d$For.type
fviz_pca_biplot(res.pca, 
                # Color individuals by the 'Species' variable
                habillage = group_variable,
                addEllipses = TRUE, # Optional: Add ellipses around groups
                ellipse.level = 0.95, # Optional: Set ellipse confidence level
                label = "var", # Only label variables (arrows/text)
                repel = TRUE, # Avoid text overlapping
                ggtheme = theme_minimal() # Use a clean ggplot theme
                )

          
```
```{r LDA Analysis}
# Load the necessary library for LDA
# library(MASS) 

# --- Data Preparation for LDA ---

# 1. Combine the numerical predictors (foret_active) and the grouping factor (For.type)
lda_data <- foretn 
lda_data$Group <- d$For.type

# 2. Filter out rows with NA values (missing data)
# This creates the clean dataset required by the lda() function
lda_data_complete <- na.omit(lda_data)

# 3. Separate the predictors and the factor variable
# All columns except the last (Group) are the predictors
active_vars_complete <- lda_data_complete[, -ncol(lda_data_complete)] 
# The last column is the grouping factor
group_var_complete <- lda_data_complete$Group

# --- Performing the LDA ---

# 4. Perform the LDA
# 'group_var_complete ~ .' predicts the group using all variables in active_vars_complete
lda_result <- lda(group_var_complete ~ ., data = active_vars_complete)

# 5. View the results
# print(lda_result)
```


```{r data preparation for visualization}
# 1. Generate the LDA scores (predictions)
# This converts the multidimensional data into scores along the single LD1 axis.
# This assumes 'lda_result' and 'active_vars_complete' are available from the previous step.
lda_scores <- predict(lda_result, active_vars_complete)$x

# 2. Create a data frame for plotting
# We need the LD1 score and the Group variable
lda_plot_data <- data.frame(
  LD1 = lda_scores[, 1],
  Group = group_var_complete
)

# 3. Plot the density curves
fig.cap="Figure 3: Linear Discriminant 1 (LD1) Scores Grouped by Forest Type"


ggplot(lda_plot_data, aes(x = LD1, fill = Group)) +
  # Use geom_density() to show the smooth distribution of scores
  geom_density(alpha = 0.6) +
  # Add a vertical line at 0 for reference (the theoretical decision boundary if priors were equal)
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  labs(
    title = "Separation of Forest Types along Linear Discriminant 1",
    x = "Linear Discriminant 1 (LD1)",
    y = "Density"
  ) +
  # Manually set colors for clarity in the report
  scale_fill_manual(values = c("Conserved forests" = "#FC4E07", "Disturbed forests" = "#00AFBB")) +
  theme_minimal()

```




\`\`\`{r}
